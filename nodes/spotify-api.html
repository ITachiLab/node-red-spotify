<script type="text/javascript">
  RED.nodes.registerType('spotify-api', {
    category: 'config',
    defaults: {
      name: {value: "My Spotify API", required: true}
    },
    credentials: {
      client_id: {required: true},
      redirect_uri: {required: true},
      client_secret: {required: true, type: "password"},
      access_token: {required: true, type: "password"},
      refresh_token: {required: true, type: "password"},
    },
    label: function () {
      return this.name || "New Spotify API";
    },
    oneditprepare: function () {
      const state = crypto.randomUUID();
      let continueInterval;

      $("#node-config-input-redirect_uri").val("http://localhost:1880/spotify/oauth");

      $("#sign-in").on("click", function () {
        const params = new URLSearchParams();

        params.append("client_id", $("#node-config-input-client_id").val());
        params.append("response_type", "code");
        params.append("redirect_uri", $("#node-config-input-redirect_uri").val());
        params.append("state", state);
        params.append("scope",
            "user-modify-playback-state,user-read-playback-state,user-read-currently-playing");

        window.open("https://accounts.spotify.com/authorize?" + params.toString());

        continueInterval = setInterval(() => {
          fetch("/spotify/oauth/continue?" + new URLSearchParams({
            client_id: $("#node-config-input-client_id").val(),
            state: state,
            secret: $("#node-config-input-client_secret").val()
          }).toString()).then(res => {
            if (res.status === 200) {
              return res.json();
            } else if (res.status === 202) {
              return Promise.resolve({});
            } else {
              return Promise.reject(res.status);
            }
          }).then(json => {
            if ("access_token" in json && "refresh_token" in json) {
              $("#node-config-input-access_token").val(json.access_token);
              $("#node-config-input-refresh_token").val(json.refresh_token);

              clearInterval(continueInterval);
            }
          }).catch(err => {
            clearInterval(continueInterval);
          });
        }, 5000);
      })
    }
  });
</script>

<script type="text/html" data-template-name="spotify-api">
  <div class="form-row">
    <h2>Mandatory section</h2>
    <div>The fields in this section are mandatory, and must be provided manually before initiating
      OAuth flow.
    </div>
  </div>
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-bookmark"></i> Name</label>
    <input type="text" id="node-config-input-name">
  </div>
  <div class="form-row">
    <label for="node-config-input-client_id"><i class="fa fa-id-badge"></i> Client ID</label>
    <input type="text" id="node-config-input-client_id">
  </div>
  <div class="form-row">
    <label for="node-config-input-redirect_uri"><i class="fa fa-undo"></i> Redirect URI</label>
    <input type="text" id="node-config-input-redirect_uri"
           value="http://localhost:1880/spotify/oauth">
  </div>
  <div class="form-row">
    <label for="node-config-input-client_secret"><i class="fa fa-key"></i> Client secret</label>
    <input type="password" id="node-config-input-client_secret">
  </div>
  <div class="form-row">
    <button id="sign-in" type="button" class="red-ui-button">Sign in to Spotify</button>
  </div>
  <div class="form-row">
    <h2>Tokens sections</h2>
    <div>Access token and refresh token will be populated automatically upon a successful OAuth
      authentication.
    </div>
  </div>
  <div class="form-row">
    <label for="node-config-input-access_token"><i class="fa fa-lock"></i> Access token</label>
    <input type="password" id="node-config-input-access_token" readonly>
  </div>
  <div class="form-row">
    <label for="node-config-input-refresh_token"><i class="fa fa-refresh"></i> Refresh token</label>
    <input type="password" id="node-config-input-refresh_token" readonly>
  </div>
</script>